<!DOCTYPE html>
<html lang="en">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
  <meta http-equiv="Content-Language" content="en-us" />
  <meta http-equiv="imagetoolbar" content="false" />
  <meta name="MSSmartTagsPreventParsing" content="true" />

  <title>Doctrine</title>

  <link rel="alternate" type="application/atom+xml" title="API Changes" href="changes.atom" />
  <link href="/oauth2-server-php-docs/css/reset.css" rel="stylesheet" type="text/css" />
  <link href="/oauth2-server-php-docs/css/960.css" rel="stylesheet" type="text/css" />
  <link href="/oauth2-server-php-docs/css/uv_active4d.css" rel="stylesheet" type="text/css" />
  <link href="/oauth2-server-php-docs/shared/css/documentation.css" media="screen" rel="stylesheet" type="text/css">
  <link href="/oauth2-server-php-docs/shared/css/pygments.css" media="screen" rel="stylesheet" type="text/css">
  <link href="/oauth2-server-php-docs/css/coderay.css" rel="stylesheet" type="text/css" />

  <script src="/oauth2-server-php-docs/shared/js/jquery.js" type="text/javascript"></script>
  <script src="/oauth2-server-php-docs/shared/js/documentation.js" type="text/javascript"></script>
</head>
<body class="api">
    <div id="header-wrapper">
      <div id="header">
        <div>
          <a class="logo" href="/oauth2-server-php-docs/">
            <img src="/oauth2-server-php-docs/images/oauth2-banner.png"/>
          </a>
          <ul class="nav">
            <li><a href="/oauth2-server-php-docs/changes/">Changes</a></li>
            <li><a href="/oauth2-server-php-docs/changes.atom">
              <img src="/oauth2-server-php-docs/images/feed-icon-28x28.png" width="16" height="16" alt="GitHub API Changes Feed" />
            </a></li>
          </ul>
        </div>
      </div><!-- #header -->
    </div><!-- #header-wrapper -->

    <div id="wrapper">
      <div class="content">
    <h1>Doctrine</h1>

<h2>Create Client and Access Token Storage</h2>

<p>To integrate doctrine into your project, first set up your models.  Let's start with just the Client and Access Token models:</p>

<div class="code-container">
<div class="langspec">Yaml</div>
<div class="CodeRay"><div class="code"><pre class="highlight"><code class="language-yaml"><span class="key">OAuthClient</span>:
  <span class="key">tableName</span>:      <span class="string"><span class="content">oauth_client</span></span>
  <span class="key">columns</span>:
    <span class="key">client_identifier</span>:
      <span class="key">type</span>:       <span class="string"><span class="content">string(50)</span></span>
      <span class="key">notnull</span>:    <span class="string"><span class="content">true</span></span>
    <span class="key">client_secret</span>:
      <span class="key">type</span>:       <span class="string"><span class="content">char(20)</span></span>
      <span class="key">notnull</span>:    <span class="string"><span class="content">true</span></span>
    <span class="key">redirect_uri</span>:
      <span class="key">type</span>:       <span class="string"><span class="content">string(255)</span></span>
      <span class="key">notnull</span>:    <span class="string"><span class="content">true</span></span>
      <span class="key">default</span>:    <span class="string"><span class="delimiter">"</span><span class="content"></span><span class="delimiter">"</span></span>

<span class="key">OAuthAccessToken</span>:
  <span class="key">tableName</span>:      <span class="string"><span class="content">oauth_access_token</span></span>
  <span class="key">columns</span>:
    <span class="key">token</span>:
      <span class="key">type</span>:       <span class="string"><span class="content">char(40)</span></span>
      <span class="key">notnull</span>:    <span class="string"><span class="content">true</span></span>
      <span class="key">unique</span>:     <span class="string"><span class="content">true</span></span>
    <span class="key">client_identifier</span>:
      <span class="key">type</span>:       <span class="string"><span class="content">string(50)</span></span>
      <span class="key">notnull</span>:    <span class="string"><span class="content">true</span></span>
    <span class="key">user_identifier</span>:
      <span class="key">type</span>:       <span class="string"><span class="content">string(100)</span></span>
      <span class="key">notnull</span>:    <span class="string"><span class="content">true</span></span>
    <span class="key">expires</span>:
      <span class="key">type</span>:       <span class="string"><span class="content">timestamp</span></span>
      <span class="key">notnull</span>:    <span class="string"><span class="content">true</span></span>
    <span class="key">scope</span>:
      <span class="key">type</span>:       <span class="string"><span class="content">string(50)</span></span>
      <span class="key">notnull</span>:    <span class="string"><span class="content">false</span></span>
  <span class="key">relations</span>:
    <span class="key">Client</span>:
      <span class="key">local</span>:        <span class="string"><span class="content">client_identifier</span></span>
      <span class="key">foreign</span>:      <span class="string"><span class="content">client_identifier</span></span>
      <span class="key">class</span>:        <span class="string"><span class="content">OAuthClient</span></span>
      <span class="key">foreignAlias</span>: <span class="string"><span class="content">AccessTokens</span></span>
      <span class="key">onDelete</span>:     <span class="string"><span class="content">CASCADE</span></span>
      <span class="key">onUpdate</span>:     <span class="string"><span class="content">CASCADE</span></span></code></pre></div></div>
</div>

<p>Once you've generated the models off this schema, you will have an <code>OAuthClient</code> and <code>OAuthCleintTable</code> class
file, as well as an <code>OAuthAccessToken</code> and <code>OAuthAccessTokenTable</code> object.</p>

<p>Implement <code>OAuth2\Storage\ClientCredentialsInterface</code> on the <code>OAuthClientTable</code> class:</p>

<div class="code-container">
<div class="langspec">Php</div>
<div class="CodeRay"><div class="code"><pre class="highlight"><code class="language-php"><span class="keyword">class</span> <span class="class">OAuthClientTable</span> <span class="keyword">extends</span> <span class="constant">PluginOAuthClientTable</span> <span class="keyword">implements</span> <span class="constant">OAuth2</span>\<span class="constant">Storage</span>\<span class="constant">ClientCredentialsInterface</span>
{
    <span class="keyword">public</span> <span class="keyword">function</span> <span class="function">getClientDetails</span>(<span class="local-variable">$client_id</span>)
    {
        <span class="local-variable">$client</span> = <span class="local-variable">$this</span>-&gt;createQuery()
            -&gt;where(<span class="string"><span class="delimiter">'</span><span class="content">client_identifier = ?</span><span class="delimiter">'</span></span>, <span class="local-variable">$client_id</span>)
            -&gt;fetchOne(<span class="predefined">array</span>(), <span class="constant">Doctrine</span>::<span class="constant">HYDRATE_ARRAY</span>);

        <span class="keyword">return</span> <span class="local-variable">$client</span>;
    }

    <span class="keyword">public</span> <span class="keyword">function</span> <span class="function">checkClientCredentials</span>(<span class="local-variable">$client_id</span>, <span class="local-variable">$client_secret</span> = <span class="predefined-constant">NULL</span>)
    {
        <span class="local-variable">$client</span> = <span class="local-variable">$this</span>-&gt;getClientDetails(<span class="local-variable">$client_id</span>);

        <span class="keyword">if</span> (<span class="local-variable">$client</span>) {
            <span class="keyword">return</span> <span class="local-variable">$client</span>[<span class="string"><span class="delimiter">'</span><span class="content">client_secret</span><span class="delimiter">'</span></span>] === <span class="predefined">sha1</span>(<span class="local-variable">$client_secret</span>);
        }
        <span class="keyword">return</span> <span class="predefined-constant">false</span>;
    }

    <span class="keyword">public</span> <span class="keyword">function</span> <span class="function">checkRestrictedGrantType</span>(<span class="local-variable">$client_id</span>, <span class="local-variable">$grant_type</span>)
    {
        <span class="comment">// we do not support different grant types per client in this example</span>
        <span class="keyword">return</span> <span class="predefined-constant">true</span>;
    }
}</code></pre></div></div>
</div>

<p>Now implement <code>OAuth2\Storage\AccessTokenInterface</code> on the <code>OAuthAccessTokenTable</code> class:</p>

<div class="code-container">
<div class="langspec">Php</div>
<div class="CodeRay"><div class="code"><pre class="highlight"><code class="language-php"><span class="keyword">class</span> <span class="class">OAuthAccessTokenTable</span> <span class="keyword">extends</span> <span class="constant">PluginOAuthAccessTokenTable</span> <span class="keyword">implements</span> <span class="constant">OAuth2</span>\<span class="constant">Storage</span>\<span class="constant">AccessTokenInterface</span>
{
    <span class="keyword">public</span> <span class="keyword">function</span> <span class="function">getAccessToken</span>(<span class="local-variable">$oauth_token</span>)
    {
        <span class="local-variable">$token</span> = <span class="local-variable">$this</span>-&gt;createQuery()
            -&gt;where(<span class="string"><span class="delimiter">'</span><span class="content">token = ?</span><span class="delimiter">'</span></span>, <span class="local-variable">$oauth_token</span>)
            -&gt;fetchOne(<span class="predefined">array</span>(), <span class="constant">Doctrine_Core</span>::<span class="constant">HYDRATE_ARRAY</span>);

        <span class="keyword">if</span> (<span class="local-variable">$token</span>) {
            <span class="keyword">return</span> <span class="predefined">array</span>(
               <span class="string"><span class="delimiter">'</span><span class="content">token</span><span class="delimiter">'</span></span>     =&gt; <span class="local-variable">$token</span>[<span class="string"><span class="delimiter">'</span><span class="content">token</span><span class="delimiter">'</span></span>],
               <span class="string"><span class="delimiter">'</span><span class="content">client_id</span><span class="delimiter">'</span></span> =&gt; <span class="local-variable">$token</span>[<span class="string"><span class="delimiter">'</span><span class="content">client_identifier</span><span class="delimiter">'</span></span>],
               <span class="string"><span class="delimiter">'</span><span class="content">expires</span><span class="delimiter">'</span></span>   =&gt; <span class="predefined">strtotime</span>(<span class="local-variable">$token</span>[<span class="string"><span class="delimiter">'</span><span class="content">expires</span><span class="delimiter">'</span></span>]),
               <span class="string"><span class="delimiter">'</span><span class="content">scope</span><span class="delimiter">'</span></span>     =&gt; <span class="local-variable">$token</span>[<span class="string"><span class="delimiter">'</span><span class="content">scope</span><span class="delimiter">'</span></span>],
               <span class="string"><span class="delimiter">'</span><span class="content">user_id</span><span class="delimiter">'</span></span>   =&gt; <span class="local-variable">$token</span>[<span class="string"><span class="delimiter">'</span><span class="content">user_identifier</span><span class="delimiter">'</span></span>],
            );
        }
    }

    <span class="keyword">public</span> <span class="keyword">function</span> <span class="function">setAccessToken</span>(<span class="local-variable">$oauth_token</span>, <span class="local-variable">$client_id</span>, <span class="local-variable">$user_id</span>, <span class="local-variable">$expires</span>, <span class="local-variable">$scope</span> = <span class="predefined-constant">null</span>)
    {
        <span class="local-variable">$token</span> = <span class="keyword">new</span> <span class="constant">OAuthAccessToken</span>();
        <span class="local-variable">$token</span>-&gt;fromArray(<span class="predefined">array</span>(
           <span class="string"><span class="delimiter">'</span><span class="content">token</span><span class="delimiter">'</span></span>              =&gt; <span class="local-variable">$oauth_token</span>,
           <span class="string"><span class="delimiter">'</span><span class="content">client_identifier</span><span class="delimiter">'</span></span>  =&gt; <span class="local-variable">$client_id</span>,
           <span class="string"><span class="delimiter">'</span><span class="content">user_identifier</span><span class="delimiter">'</span></span>    =&gt; <span class="local-variable">$user_id</span>,
           <span class="string"><span class="delimiter">'</span><span class="content">expires</span><span class="delimiter">'</span></span>            =&gt; <span class="predefined">date</span>(<span class="string"><span class="delimiter">'</span><span class="content">Y-m-d H:i:s</span><span class="delimiter">'</span></span>, <span class="local-variable">$expires</span>),
           <span class="string"><span class="delimiter">'</span><span class="content">scope</span><span class="delimiter">'</span></span>              =&gt; <span class="local-variable">$scope</span>,
        ));

        <span class="local-variable">$token</span>-&gt;save();
    }
}</code></pre></div></div>
</div>

<p>Good job!  Now, when you create your <code>OAuth\Server</code> object, pass these tables in:</p>

<div class="code-container">
<div class="langspec">Php</div>
<div class="CodeRay"><div class="code"><pre class="highlight"><code class="language-php"><span class="local-variable">$clientStore</span> = <span class="constant">Doctrine</span>::getTable(<span class="string"><span class="delimiter">'</span><span class="content">OAuthClient</span><span class="delimiter">'</span></span>);
<span class="local-variable">$tokenStore</span>  = <span class="constant">Doctrine</span>::getTable(<span class="string"><span class="delimiter">'</span><span class="content">OAuthAccessToken</span><span class="delimiter">'</span></span>);

<span class="comment">// Pass the doctrine storage objects to the OAuth2 server class</span>
<span class="local-variable">$server</span> = <span class="keyword">new</span> <span class="constant">OAuth2</span>\<span class="constant">Server</span>(<span class="predefined">array</span>(<span class="string"><span class="delimiter">'</span><span class="content">client_credentials</span><span class="delimiter">'</span></span> =&gt; <span class="local-variable">$clientStore</span>, <span class="string"><span class="delimiter">'</span><span class="content">access_token</span><span class="delimiter">'</span></span> =&gt; <span class="local-variable">$tokenStore</span>));</code></pre></div></div>
</div>

<p>You've done it!  You've integrated your server with Doctrine!  You can go to town using it, but
since you've only passed it a <code>client_credentials</code> and <code>access_token</code> storage object, you can only
use the <code>client_credentials</code> grant type:</p>

<div class="code-container">
<div class="langspec">Php</div>
<div class="CodeRay"><div class="code"><pre class="highlight"><code class="language-php"><span class="comment">// will only be able to handle token requests when "grant_type=client_credentials".</span>
<span class="local-variable">$server</span>-&gt;addGrantType(<span class="keyword">new</span> <span class="constant">OAuth2</span>\<span class="constant">GrantType</span>\<span class="constant">ClientCredentials</span>(<span class="local-variable">$clientStorage</span>));

<span class="comment">// handle the request</span>
<span class="local-variable">$server</span>-&gt;handleTokenRequest(<span class="constant">OAuth2</span>\<span class="constant">Request</span>::createFromGlobals())-&gt;send();</code></pre></div></div>
</div>

<h2>Add Authorization Code and Refresh Token Storage</h2>

<p>So lets make our application a little more exciting.  Add the following to your schema and
generate the class files:</p>

<div class="code-container">
<div class="langspec">Yaml</div>
<div class="CodeRay"><div class="code"><pre class="highlight"><code class="language-yaml"><span class="key">OAuthAuthorizationCode</span>:
  <span class="key">tableName</span>:      <span class="string"><span class="content">oauth_authorization_code</span></span>
  <span class="key">columns</span>:
    <span class="key">code</span>:
      <span class="key">type</span>:       <span class="string"><span class="content">char(40)</span></span>
      <span class="key">notnull</span>:    <span class="string"><span class="content">true</span></span>
      <span class="key">unique</span>:     <span class="string"><span class="content">true</span></span>
    <span class="key">client_identifier</span>:
      <span class="key">type</span>:       <span class="string"><span class="content">string(50)</span></span>
      <span class="key">notnull</span>:    <span class="string"><span class="content">true</span></span>
    <span class="key">expires</span>:
      <span class="key">type</span>:       <span class="string"><span class="content">timestamp</span></span>
      <span class="key">notnull</span>:    <span class="string"><span class="content">true</span></span>
    <span class="key">user_identifier</span>:
      <span class="key">type</span>:       <span class="string"><span class="content">string(100)</span></span>
      <span class="key">notnull</span>:    <span class="string"><span class="content">true</span></span>
    <span class="key">redirect_uri</span>:
      <span class="key">type</span>:       <span class="string"><span class="content">string(200)</span></span>
      <span class="key">notnull</span>:    <span class="string"><span class="content">true</span></span>
    <span class="key">scope</span>:
      <span class="key">type</span>:       <span class="string"><span class="content">string(50)</span></span>
      <span class="key">notnull</span>:    <span class="string"><span class="content">false</span></span>
  <span class="key">relations</span>:
    <span class="key">Client</span>:
      <span class="key">local</span>:        <span class="string"><span class="content">client_identifier</span></span>
      <span class="key">foreign</span>:      <span class="string"><span class="content">client_identifier</span></span>
      <span class="key">class</span>:        <span class="string"><span class="content">OAuthClient</span></span>
      <span class="key">foreignAlias</span>: <span class="string"><span class="content">AuthorizationCodes</span></span>
      <span class="key">onDelete</span>:     <span class="string"><span class="content">CASCADE</span></span>
      <span class="key">onUpdate</span>:     <span class="string"><span class="content">CASCADE</span></span>

<span class="key">OAuthRefreshToken</span>:
  <span class="key">tableName</span>:      <span class="string"><span class="content">oauth_refresh_token</span></span>
  <span class="key">columns</span>:
    <span class="key">refresh_token</span>:
      <span class="key">type</span>:       <span class="string"><span class="content">char(40)</span></span>
      <span class="key">notnull</span>:    <span class="string"><span class="content">true</span></span>
      <span class="key">unique</span>:     <span class="string"><span class="content">true</span></span>
    <span class="key">client_identifier</span>:
      <span class="key">type</span>:       <span class="string"><span class="content">string(50)</span></span>
      <span class="key">notnull</span>:    <span class="string"><span class="content">true</span></span>
    <span class="key">user_identifier</span>:
      <span class="key">type</span>:       <span class="string"><span class="content">string(100)</span></span>
      <span class="key">notnull</span>:    <span class="string"><span class="content">true</span></span>
    <span class="key">expires</span>:
      <span class="key">type</span>:       <span class="string"><span class="content">timestamp</span></span>
      <span class="key">notnull</span>:    <span class="string"><span class="content">true</span></span>
    <span class="key">scope</span>:
      <span class="key">type</span>:       <span class="string"><span class="content">string(50)</span></span>
      <span class="key">notnull</span>:    <span class="string"><span class="content">false</span></span>
  <span class="key">relations</span>:
    <span class="key">Client</span>:
      <span class="key">local</span>:        <span class="string"><span class="content">client_identifier</span></span>
      <span class="key">foreign</span>:      <span class="string"><span class="content">client_identifier</span></span>
      <span class="key">class</span>:        <span class="string"><span class="content">OAuthClient</span></span>
      <span class="key">foreignAlias</span>: <span class="string"><span class="content">RefreshTokens</span></span>
      <span class="key">onDelete</span>:     <span class="string"><span class="content">CASCADE</span></span>
      <span class="key">onUpdate</span>:     <span class="string"><span class="content">CASCADE</span></span></code></pre></div></div>
</div>

<p>Now we can implement two more interfaces, <code>OAuth2\Storage\AuthorizationCodeInterface</code> and
<code>OAuth2\Storage\RefreshTokenInterface</code>.  This will allow us to use their correspoding grant
types as well.</p>

<p>Implement <code>OAuth2\Storage\AuthorizationCodeInterface</code> on the <code>OAuthAuthorizationCodeTable</code> class:</p>

<div class="code-container">
<div class="langspec">Php</div>
<div class="CodeRay"><div class="code"><pre class="highlight"><code class="language-php"><span class="keyword">class</span> <span class="class">OAuthAuthorizationCodeTable</span> <span class="keyword">extends</span> <span class="constant">PluginOAuthAuthorizationCodeTable</span> <span class="keyword">implements</span> <span class="constant">OAuth2</span>\<span class="constant">Storage</span>\<span class="constant">AuthorizationCodeInterface</span>
{
    <span class="keyword">public</span> <span class="keyword">function</span> <span class="function">getAuthorizationCode</span>(<span class="local-variable">$code</span>)
    {
        <span class="local-variable">$auth_code</span> = <span class="local-variable">$this</span>-&gt;createQuery()
            -&gt;where(<span class="string"><span class="delimiter">'</span><span class="content">code = ?</span><span class="delimiter">'</span></span>, <span class="local-variable">$code</span>)
            -&gt;fetchOne(<span class="predefined">array</span>(), <span class="constant">Doctrine_Core</span>::<span class="constant">HYDRATE_ARRAY</span>);

        <span class="keyword">if</span> (<span class="local-variable">$auth_code</span>) {
            <span class="keyword">return</span> <span class="predefined">array</span>(
               <span class="string"><span class="delimiter">'</span><span class="content">code</span><span class="delimiter">'</span></span>         =&gt; <span class="local-variable">$auth_code</span>[<span class="string"><span class="delimiter">'</span><span class="content">code</span><span class="delimiter">'</span></span>],
               <span class="string"><span class="delimiter">'</span><span class="content">client_id</span><span class="delimiter">'</span></span>    =&gt; <span class="local-variable">$auth_code</span>[<span class="string"><span class="delimiter">'</span><span class="content">client_identifier</span><span class="delimiter">'</span></span>],
               <span class="string"><span class="delimiter">'</span><span class="content">user_id</span><span class="delimiter">'</span></span>      =&gt; <span class="local-variable">$auth_code</span>[<span class="string"><span class="delimiter">'</span><span class="content">web_service_username</span><span class="delimiter">'</span></span>],
               <span class="string"><span class="delimiter">'</span><span class="content">redirect_uri</span><span class="delimiter">'</span></span> =&gt; <span class="local-variable">$auth_code</span>[<span class="string"><span class="delimiter">'</span><span class="content">redirect_uri</span><span class="delimiter">'</span></span>],
               <span class="string"><span class="delimiter">'</span><span class="content">expires</span><span class="delimiter">'</span></span>      =&gt; <span class="predefined">strtotime</span>(<span class="local-variable">$auth_code</span>[<span class="string"><span class="delimiter">'</span><span class="content">expires</span><span class="delimiter">'</span></span>]),
               <span class="string"><span class="delimiter">'</span><span class="content">scope</span><span class="delimiter">'</span></span>        =&gt; <span class="local-variable">$auth_code</span>[<span class="string"><span class="delimiter">'</span><span class="content">scope</span><span class="delimiter">'</span></span>],
            );
        }
        <span class="keyword">return</span> <span class="predefined-constant">null</span>;
    }

    <span class="keyword">public</span> <span class="keyword">function</span> <span class="function">setAuthorizationCode</span>(<span class="local-variable">$code</span>, <span class="local-variable">$client_id</span>, <span class="local-variable">$user_id</span>, <span class="local-variable">$redirect_uri</span>, <span class="local-variable">$expires</span>, <span class="local-variable">$scope</span> = <span class="predefined-constant">null</span>)
    {
        <span class="local-variable">$auth_code</span> = <span class="keyword">new</span> <span class="constant">OAuthAuthorizationCode</span>();
        <span class="local-variable">$auth_code</span>-&gt;fromArray(<span class="predefined">array</span>(
           <span class="string"><span class="delimiter">'</span><span class="content">code</span><span class="delimiter">'</span></span>                 =&gt; <span class="local-variable">$code</span>,
           <span class="string"><span class="delimiter">'</span><span class="content">client_identifier</span><span class="delimiter">'</span></span>    =&gt; <span class="local-variable">$client_id</span>,
           <span class="string"><span class="delimiter">'</span><span class="content">web_service_username</span><span class="delimiter">'</span></span> =&gt; <span class="local-variable">$user_id</span>,
           <span class="string"><span class="delimiter">'</span><span class="content">redirect_uri</span><span class="delimiter">'</span></span>         =&gt; <span class="local-variable">$redirect_uri</span>,
           <span class="string"><span class="delimiter">'</span><span class="content">expires</span><span class="delimiter">'</span></span>              =&gt; <span class="predefined">date</span>(<span class="string"><span class="delimiter">'</span><span class="content">Y-m-d H:i:s</span><span class="delimiter">'</span></span>, <span class="local-variable">$expires</span>),
           <span class="string"><span class="delimiter">'</span><span class="content">scope</span><span class="delimiter">'</span></span>                =&gt; <span class="local-variable">$scope</span>,
        ));

        <span class="local-variable">$auth_code</span>-&gt;save();
    }

    <span class="keyword">public</span> <span class="keyword">function</span> <span class="function">expireAuthorizationCode</span>(<span class="local-variable">$code</span>)
    {
        <span class="keyword">return</span> <span class="local-variable">$this</span>-&gt;createQuery()
            -&gt;<span class="predefined">delete</span>()
            -&gt;where(<span class="string"><span class="delimiter">'</span><span class="content">code = ?</span><span class="delimiter">'</span></span>, <span class="local-variable">$code</span>)
            -&gt;execute();
    }
}</code></pre></div></div>
</div>

<p>Implement <code>OAuth2\Storage\RefreshTokenInterface</code> on the <code>OAuthRefreshTokenTable</code> class:</p>

<div class="code-container">
<div class="langspec">Php</div>
<div class="CodeRay"><div class="code"><pre class="highlight"><code class="language-php"><span class="keyword">class</span> <span class="class">OAuthRefreshTokenTable</span> <span class="keyword">extends</span> <span class="constant">PluginOAuthRefreshTokenTable</span> <span class="keyword">implements</span> <span class="constant">OAuth2</span>\<span class="constant">Storage</span>\<span class="constant">RefreshTokenInterface</span>
{
    <span class="keyword">public</span> <span class="keyword">function</span> <span class="function">getRefreshToken</span>(<span class="local-variable">$refresh_token</span>)
    {
        <span class="local-variable">$refresh_token</span> = <span class="local-variable">$this</span>-&gt;createQuery()
            -&gt;where(<span class="string"><span class="delimiter">'</span><span class="content">refresh_token = ?</span><span class="delimiter">'</span></span>, <span class="local-variable">$refresh_token</span>)
            -&gt;fetchOne(<span class="predefined">array</span>(), <span class="constant">Doctrine_Core</span>::<span class="constant">HYDRATE_ARRAY</span>);

        <span class="keyword">if</span> (<span class="local-variable">$auth_code</span>) {
            <span class="keyword">return</span> <span class="predefined">array</span>(
               <span class="string"><span class="delimiter">'</span><span class="content">refresh_token</span><span class="delimiter">'</span></span> =&gt; <span class="local-variable">$refresh_token</span>[<span class="string"><span class="delimiter">'</span><span class="content">refresh_token</span><span class="delimiter">'</span></span>],
               <span class="string"><span class="delimiter">'</span><span class="content">client_id</span><span class="delimiter">'</span></span>     =&gt; <span class="local-variable">$refresh_token</span>[<span class="string"><span class="delimiter">'</span><span class="content">client_identifier</span><span class="delimiter">'</span></span>],
               <span class="string"><span class="delimiter">'</span><span class="content">user_id</span><span class="delimiter">'</span></span>       =&gt; <span class="local-variable">$refresh_token</span>[<span class="string"><span class="delimiter">'</span><span class="content">user_identifier</span><span class="delimiter">'</span></span>],
               <span class="string"><span class="delimiter">'</span><span class="content">expires</span><span class="delimiter">'</span></span>       =&gt; <span class="predefined">strtotime</span>(<span class="local-variable">$refresh_token</span>[<span class="string"><span class="delimiter">'</span><span class="content">expires</span><span class="delimiter">'</span></span>]),
               <span class="string"><span class="delimiter">'</span><span class="content">scope</span><span class="delimiter">'</span></span>         =&gt; <span class="local-variable">$refresh_token</span>[<span class="string"><span class="delimiter">'</span><span class="content">scope</span><span class="delimiter">'</span></span>],
            );
        }
    }

    <span class="keyword">public</span> <span class="keyword">function</span> <span class="function">setRefreshToken</span>(<span class="local-variable">$refresh_token</span>, <span class="local-variable">$client_id</span>, <span class="local-variable">$user_id</span>, <span class="local-variable">$expires</span>, <span class="local-variable">$scope</span> = <span class="predefined-constant">null</span>)
    {
        <span class="local-variable">$refresh_token</span> = <span class="keyword">new</span> <span class="constant">OAuthRefreshToken</span>();
        <span class="local-variable">$refresh_token</span>-&gt;fromArray(<span class="predefined">array</span>(
           <span class="string"><span class="delimiter">'</span><span class="content">code</span><span class="delimiter">'</span></span>              =&gt; <span class="local-variable">$code</span>,
           <span class="string"><span class="delimiter">'</span><span class="content">client_identifier</span><span class="delimiter">'</span></span> =&gt; <span class="local-variable">$client_id</span>,
           <span class="string"><span class="delimiter">'</span><span class="content">user_identifier</span><span class="delimiter">'</span></span>   =&gt; <span class="local-variable">$user_id</span>,
           <span class="string"><span class="delimiter">'</span><span class="content">expires</span><span class="delimiter">'</span></span>           =&gt; <span class="predefined">date</span>(<span class="string"><span class="delimiter">'</span><span class="content">Y-m-d H:i:s</span><span class="delimiter">'</span></span>, <span class="local-variable">$expires</span>),
           <span class="string"><span class="delimiter">'</span><span class="content">scope</span><span class="delimiter">'</span></span>             =&gt; <span class="local-variable">$scope</span>,
        ));

        <span class="local-variable">$refresh_token</span>-&gt;save();
    }

    <span class="keyword">public</span> <span class="keyword">function</span> <span class="function">unsetRefreshToken</span>(<span class="local-variable">$refresh_token</span>)
    {
        <span class="keyword">return</span> <span class="local-variable">$this</span>-&gt;createQuery()
            -&gt;<span class="predefined">delete</span>()
            -&gt;where(<span class="string"><span class="delimiter">'</span><span class="content">refresh_token = ?</span><span class="delimiter">'</span></span>, <span class="local-variable">$refresh_token</span>)
            -&gt;execute();
    }
}</code></pre></div></div>
</div>

<p>Now we can add two more grant types onto our server:</p>

<div class="code-container">
<div class="langspec">Php</div>
<div class="CodeRay"><div class="code"><pre class="highlight"><code class="language-php"><span class="local-variable">$clientStore</span>  = <span class="constant">Doctrine</span>::getTable(<span class="string"><span class="delimiter">'</span><span class="content">OAuthClient</span><span class="delimiter">'</span></span>);
<span class="local-variable">$tokenStore</span>   = <span class="constant">Doctrine</span>::getTable(<span class="string"><span class="delimiter">'</span><span class="content">OAuthAccessToken</span><span class="delimiter">'</span></span>);
<span class="local-variable">$codeStore</span>    = <span class="constant">Doctrine</span>::getTable(<span class="string"><span class="delimiter">'</span><span class="content">OAuthAuthorizationCode</span><span class="delimiter">'</span></span>);
<span class="local-variable">$refreshStore</span> = <span class="constant">Doctrine</span>::getTable(<span class="string"><span class="delimiter">'</span><span class="content">OAuthRefreshToken</span><span class="delimiter">'</span></span>);

<span class="comment">// Pass the doctrine storage objects to the OAuth2 server class</span>
<span class="local-variable">$server</span> = <span class="keyword">new</span> <span class="constant">OAuth2</span>\<span class="constant">Server</span>(<span class="predefined">array</span>(
    <span class="string"><span class="delimiter">'</span><span class="content">client_credentials</span><span class="delimiter">'</span></span> =&gt; <span class="local-variable">$clientStore</span>,
    <span class="string"><span class="delimiter">'</span><span class="content">access_token</span><span class="delimiter">'</span></span>       =&gt; <span class="local-variable">$tokenStore</span>,
    <span class="string"><span class="delimiter">'</span><span class="content">authorization_code</span><span class="delimiter">'</span></span> =&gt; <span class="local-variable">$codeStore</span>,
    <span class="string"><span class="delimiter">'</span><span class="content">refresh_token</span><span class="delimiter">'</span></span>      =&gt; <span class="local-variable">$refreshStore</span>,
));

<span class="local-variable">$server</span>-&gt;addGrantType(<span class="keyword">new</span> <span class="constant">OAuth2</span>\<span class="constant">GrantType</span>\<span class="constant">ClientCredentials</span>(<span class="local-variable">$clientStorage</span>));
<span class="local-variable">$server</span>-&gt;addGrantType(<span class="keyword">new</span> <span class="constant">OAuth2</span>\<span class="constant">GrantType</span>\<span class="constant">AuthorizationCode</span>(<span class="local-variable">$codeStorage</span>));
<span class="local-variable">$server</span>-&gt;addGrantType(<span class="keyword">new</span> <span class="constant">OAuth2</span>\<span class="constant">GrantType</span>\<span class="constant">RefreshToken</span>(<span class="local-variable">$refreshStorage</span>));

<span class="comment">// handle the request</span>
<span class="local-variable">$server</span>-&gt;handleTokenRequest(<span class="constant">OAuth2</span>\<span class="constant">Request</span>::createFromGlobals())-&gt;send();</code></pre></div></div>
</div>

<p>You've done it!!! Well, almost all of it.  The only thing left is to add your
user!  Well, see the symfony documentation for how to integrate with
<code>sfGuardUser</code>.</p>
      </div>

    <div id="js-sidebar" class="sidebar-shell">
      <div class="js-toggle-list sidebar-module expandable">
        <ul>
          <li class="js-topic">
            <h3><a href="#" class="js-expand-btn collapsed">&nbsp;</a><a href="/oauth2-server-php-docs/overview/methods/">Overview</a></h3>
            <ul class="js-guides">
              <li><a href="/oauth2-server-php-docs/overview/methods/">Methods</a></li>
              <li><a href="/oauth2-server-php-docs/overview/grant-types/">Grant Types</a></li>
              <li><a href="/oauth2-server-php-docs/overview/response/">Response</a></li>
              <li><a href="/oauth2-server-php-docs/overview/scope/">Scope</a></li>
              <li><a href="/oauth2-server-php-docs/overview/userid/">User ID</a></li>
            </ul>
          </li>
          <li class="js-topic">
            <h3><a href="#" class="js-expand-btn collapsed">&nbsp;</a><a href="/oauth2-server-php-docs/cookbook/">Cookbook</a></h3>
            <ul class="js-guides">
              <li><a href="/oauth2-server-php-docs/cookbook/">Step-By-Step Walkthrough</a></li>
              <li><a href="/oauth2-server-php-docs/cookbook/doctrine/">Doctrine</a></li>
              <li><a href="/oauth2-server-php-docs/cookbook/silex/">Silex</a></li>
              <li><a href="/oauth2-server-php-docs/cookbook/drupal/">Drupal</a></li>
              <li><a href="/oauth2-server-php-docs/cookbook/google-playground/">Google Playground</a></li>
              <li><a href="/oauth2-server-php-docs/cookbook/symfony2/">Symfony2</a></li>
              <li><a href="/oauth2-server-php-docs/cookbook/restler/">Restler</a></li>
              <!-- <li><a href="/oauth2-server-php-docs/cookbook/doctrine2/">Doctrine2</a></li>
              <li><a href="/oauth2-server-php-docs/cookbook/symfony/">Symfony 1.4</a></li>
              <li><a href="/oauth2-server-php-docs/cookbook/laravel/">Laravel</a></li> -->
            </ul>
          </li>
        </ul>
      </div> <!-- /sidebar-module -->
      <div class="sidebar-module">
        <p>This project is open source. Please help us by forking the project and adding to it.</p>
      </div>
    </div><!-- /sidebar-shell -->

    </div><!-- #wrapper -->

    <div id="footer" >
      <div class="upper_footer">
        <div class="footer_inner clearfix">

        </div><!-- /.site -->
      </div><!-- /.upper_footer -->

      <div class="lower_footer">
        <div class="footer_inner clearfix">
            <div id="legal">
              <p>&copy; <span id="year">year</span> Brent Shaffer. All rights reserved.</p>
            </div><!-- /#legal or /#legal_ie-->
        </div><!-- /.site -->
      </div><!-- /.lower_footer -->
    </div><!-- /#footer -->
    <a href="https://github.com/bshaffer/oauth2-server-php-docs"><img style="position: absolute; top: 0; right: 0; border: 0;" src="https://s3.amazonaws.com/github/ribbons/forkme_right_gray_6d6d6d.png" alt="Fork me on GitHub"></a>
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-11590669-6', 'bshaffer.github.io');
      ga('send', 'pageview');
    </script>
</body>
</html>
